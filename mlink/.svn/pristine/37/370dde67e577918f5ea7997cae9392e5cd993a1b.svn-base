var coupon_money = new Array();
coupon_money['dollar'] = '$'; 
coupon_money['euro'] = '&euro;'; 
coupon_money['pound'] = '&pound;';

var promotion_detail = new Array();
promotion_detail['other'] = 'Other';
promotion_detail['percent'] = '% OFF';
promotion_detail['money'] = '$ OFF';
promotion_detail['free_shipping'] = 'Free Shipping';
promotion_detail['free_sample'] = 'Free Sample';
promotion_detail['free_gift'] = 'Free Gifts';
promotion_detail['bngn'] = 'BNGN';
//promotion_detail['bogo'] = 'BNGN';

var coupon_type = new Array();
coupon_type['1'] = 'Coupon';
coupon_type['2'] = 'Printable coupon';
coupon_type['3'] = 'Deal';
coupon_type['4'] = 'Product Deal';
coupon_type['5'] = 'Exclusive Coupon';
coupon_type['6'] = 'Premier';

var source_type = new Array();
/*
source_type['none'] = 'None';
source_type['other'] = 'Other';
source_type['community'] = 'Community';
//source_type['Competitor'] = 'Competitor';
//source_type['cpq'] = 'CPQ';
source_type['cpq|Other'] = 'CPQ|Other';//merge 13-06-17
source_type['cpq|AFFILIATE'] = 'CPQ|Affiliate';
source_type['cpq|COMPETITOR'] = 'CPQ|Competitor';
source_type['CPQ|COMPETITOR|DS - Database'] = 'CPQ|Competitor|DiscountStory';
source_type['CPQ|COMPETITOR|CS_SITE'] = 'CPQ|Competitor|CS_SITE';
source_type['CPQ|APL'] = 'CPQ|APL';//add 13-09-04
source_type['CPQ|PopShops'] = 'CPQ|PopShops';//add 13-10-09
source_type['CPQ|Coupilia'] = 'CPQ|Coupilia';//add 13-10-09
source_type['email|AFFILIATE'] = 'Email|Affiliate';
source_type['email|MERCHANT'] = 'Email|Merchant';
source_type['email|Urgent'] = 'Email|Urgent';//add 13-06-17
source_type['email|OTHER'] = 'Email|Other';
//source_type['Merchant'] = 'Merchant';
source_type['mmc|Other'] = 'MMC|Other';
source_type['mmc|Competitor'] = 'MMC|Competitor';
source_type['mmc|Merchant'] = 'MMC|Merchant';
source_type['share'] = 'Share';
source_type['share|QUICK'] = 'Share|Quick';
source_type["Tag|TMC"] =  "Tag|TMC";
source_type["Tag|Merchant"] =  "Tag|Merchant";
source_type["Tag|Other"] =  "Tag|Other";
source_type['New Mer|Competitor'] = 'New Mer|Competitor';//add 13-06-17 
source_type['New Mer|Merchant'] = 'New Mer|Merchant';//add 13-06-17  
source_type['New Mer|Other'] = 'New Mer|Other';//add 13-06-17 
*/

source_type["none"] 				= "- Please Select -";
source_type["community"] 			= "Community";
source_type["cpq|AFFILIATE"] 		= "CPQ|Affiliate";
source_type["cpq|COMPETITOR"]		= "CPQ|Competitor";
source_type["CPQ|COMPETITOR|DS - Database"]	= "CPQ|Competitor|DiscountStory";
source_type["CPQ|COMPETITOR|CS_SITE"]	= "CPQ|Competitor|CS_Site";
source_type["cpq|Other"]			= "CPQ|Other"; //merge 13-06-17

source_type["CPQ|CS_SITE|US_MERCHANT"]	= "CPQ|CS_SITE|US_MERCHANT";
source_type["CPQ|CS_SITE|AU_MERCHANT"] 	= "CPQ|CS_SITE|AU_MERCHANT";
source_type["CPQ|CS_SITE|CA_MERCHANT"] 	= "CPQ|CS_SITE|CA_MERCHANT";
source_type["CPQ|CS_SITE|UK_MERCHANT"] 	= "CPQ|CS_SITE|UK_MERCHANT";
source_type["CPQ|CS_SITE|DE_MERCHANT"] 	= "CPQ|CS_SITE|DE_MERCHANT";
source_type["CPQ|CS_SITE|MERCHANT"] 	= "CPQ|CS_SITE|MERCHANT";
            
source_type["email|AFFILIATE"]		= "Email|Affiliate";
source_type["email|MERCHANT"] 		= "Email|Merchant";
source_type["email|OTHER"] 			= "Email|Other";
source_type["urgent"] 				= "Urgent";//add 14-02-18
source_type["mmc|Affiliate"] 		= "MMC|Affiliate";//add 14-02-18
source_type["mmc|Competitor"] 		= "MMC|Competitor";
source_type["mmc|Merchant"]			= "MMC|Merchant";
source_type["mmc|Other"]			= "MMC|Other";//update 13-06-17
source_type["New Mer|Competitor"]	= "New Mer|Competitor";//add 13-06-17 
source_type["New Merâ”‚Email"]		= "New Mer|Email";//add 14-02-18
source_type["New Mer|Merchant"]		= "New Mer|Merchant";//add 13-06-17
source_type["New Mer|Other"]		= "New Mer|Other";//add 13-06-17
source_type["Tag|Merchant"]			= "Tag|Merchant";
source_type["Tag|Other"]			= "Tag|Other";
source_type["Tag|TMC"]				= "Tag|TMC";
source_type["share"] 				= "Share";
source_type["Share|QUICK"] 			= "Share|Quick";
source_type["other"] 				= "Other";

var fieldinfo_prefix = new Array();
fieldinfo_prefix['codepromotiondeal'] = {code_: 'code_', pro_off_: 'pro_off_', money_type_: 'money_type_', pro_detail_: 'pro_detail_', site_wide_: 'site_wide_'};

fieldinfo_prefix['title'] = {title_: 'title_'};

fieldinfo_prefix['description'] = {desc_: 'desc_'};

fieldinfo_prefix['restrict'] = {restrict_: 'restrict_'};

fieldinfo_prefix['startenddate'] = {sdate_: 'sdate_', edate_: 'edate_', rdate_: 'rdate_'};

fieldinfo_prefix['tags'] = {tagsall_: 'tagsall_'};

fieldinfo_prefix['category'] = {tagsall_: 'category_all_hide_'};


var visible_field_info_prefix = new Array();
visible_field_info_prefix['codepromotiondeal'] = {pdetail_: 'pdetail_', couponcode_: 'couponcode_', psitewide_: 'psitewide_'};

visible_field_info_prefix['title'] = {vtitle_: 'vtitle_'};

visible_field_info_prefix['description'] = {vdesc_: 'vdesc_'};

visible_field_info_prefix['restrict'] = {vrestrict_: 'vrestrict_'};

visible_field_info_prefix['startenddate'] = {startdate_: 'startdate_', expiration_: 'expiration_', reminddate_: 'reminddate_'};

visible_field_info_prefix['tags'] = {vtagsall_: 'vtagsall_'};

visible_field_info_prefix['category'] = {vcategoryall_: 'category_all_hide_'};


var field_visible_mapping = new Array();
field_visible_mapping['site_wide_'] = 'psitewide_';
field_visible_mapping['code_'] = 'couponcode_';
field_visible_mapping['pro_off_'] = 'pdetail_';
field_visible_mapping['money_type_'] = 'pdetail_';
field_visible_mapping['pro_detail_'] = 'pdetail_';
field_visible_mapping['title_'] = 'vtitle_';
field_visible_mapping['desc_'] = 'vdesc_';
field_visible_mapping['restrict_'] = 'vrestrict_';
field_visible_mapping['sdate_'] = 'startdate_';
field_visible_mapping['edate_'] = 'expiration_';
field_visible_mapping['rdate_'] = 'reminddate_';
field_visible_mapping['tagsall_'] = 'vtagsall_';
visible_field_info_prefix['category_all_hide_'] = "vcategoryall_";



function generateCouponSiteWideSelect(_selected) {
	var siteWideSelect = '<select class="codepromotiondeal" id="site_wide_">';
	if (_selected == 'YES') siteWideSelect += '<option value="YES" selected="selected">YES</option>';
	else siteWideSelect += '<option value="YES">YES</option>';
	
	if (_selected == 'NO') siteWideSelect += '<option value="NO" selected="selected">NO</option>';
	else siteWideSelect += '<option value="NO">NO</option>';
	
	siteWideSelect += '</select>';
	
	return siteWideSelect;
}

function generateCouponMoneySelect(_selected, isvisible) {
	var couponMoneySelect = '';
	if (isvisible) {
		couponMoneySelect += '<select class="codepromotiondeal" id="money_type_">';
	} else {
		couponMoneySelect += '<select class="codepromotiondeal" id="money_type_" style="display:none;">';
	}
	
	for (var i in coupon_money) {
		if (i == _selected) couponMoneySelect += '<option value="' + i + '" selected="selected">' + coupon_money[i] + '</option>';
		else couponMoneySelect += '<option value="' + i + '">' + coupon_money[i] + '</option>';
	}
	
	couponMoneySelect += '</select>';
	
	return couponMoneySelect;
}

function generatePromotionDetailSelect(_selected) {
	var promotionDetailSelect = '<select class="codepromotiondeal" id="pro_detail_" onchange="changePromotionDetail(this);">';
	
	for (var i in promotion_detail) {
		if (i == _selected) promotionDetailSelect += '<option value="' + i + '" selected="selected">' + promotion_detail[i] + '</option>';
		else promotionDetailSelect += '<option value="' + i + '">' + promotion_detail[i] + '</option>';
	}
	
	promotionDetailSelect += '</select>';
	
	return promotionDetailSelect;
}

function generateCouponSourceSelect() {
	var CouponSourceSelect = '';
	CouponSourceSelect += '<select id="sourcenew_">';
	
	for (var i in source_type) {
		CouponSourceSelect += '<option value="' + i + '">' + source_type[i] + '</option>';
	}
	
	CouponSourceSelect += '</select>';
	
	return CouponSourceSelect;
}

function changePromotionDetail(obj) {
	var _selectedValue = $(obj).val();
	
	if (_selectedValue == 'money') {
		$("#money_type_").attr("style", "display:'';");
		$("#pro_off_").attr("style", "display:'';");
	} else if (_selectedValue == 'percent') {
		$("#money_type_").attr("style", "display:none;");
		$("#pro_off_").attr("style", "display:'';");
	} else {
		$("#money_type_").attr("style", "display:none;");
		$("#pro_off_").attr("style", "display:none;");
	}
}



var layerVisible = false;
$(document).ready(function(){
	$("#processInfoTop, #processInfoBottom").attr("value", 'All');
	addClickOnEditArea();
	$("table").unbind("click.Layer");
	$("table").bind("click.Layer", function(){
		closeLayer();	
	});
});

function closeLayer() {
	$(".bglayer").attr('style', 'display:none;');
	if (layerVisible) {
		$("#poplayer").hide();
		layerVisible = false;
	}
}

sflag = false;
function selectAllItems() {
	if (sflag == true) {
		sflag = false;
	} else {
		$("." + arguments[0]).each(function(){
			if ($(this).attr("checked") == true) {
				sflag = true;
				return;
			}
		});
	}
	
	if (sflag) {
		$("." + arguments[0]).attr('checked', 'checked');
		$("." + arguments[1]).attr('checked', 'checked');
	} else {
		$("." + arguments[0]).removeAttr('checked');
		$("." + arguments[1]).removeAttr('checked');
	}
}

function syncSelect(obj) {
	if ($(obj).attr("id") == 'processInfoTop') $("#processInfoBottom").attr("value", $(obj).val());
	else if ($(obj).attr("id") == 'processInfoBottom') $("#processInfoTop").attr("value", $(obj).val());
}

function markSelectedItems(pos) {
	var c_ids;
	var c_ids_arr = new Array();
	var _flag = false;
	var site = $("#site").val();
	
	$(".processtatuscheckbox").each(function(){
		if ($(this).attr('checked') == true) {
			_flag = true;
			return;
		}
	});
	
	if (_flag != true) {
		alert('Please select at least 1 promotion first!');
		return false;
	}
    
	if ($("#" + pos).val() == 'All') {
		alert('Please select batch action Type first!');
		return false;
	} else if ($("#" + pos).val() == 'IsActive-YES') {
		if (!confirm("Please confirm to set selected promotions Active?")) return false;
	} else if ($("#" + pos).val() == 'IsActive-NO') {
		if (!confirm("Please confirm to set selected promotions Inactive?")) return false;
	} else if ($("#" + pos).val() == 'ExpireDateType-Fixed') {
		if (!confirm("Please confirm to set selected promotions Expired?")) return false;
	} else if ($("#" + pos).val() == 'RemindDate') {
		if (!confirm("Please confirm to delay reminddate selected promotions?")) return false;
	}
    
	$(".processtatuscheckbox").each(function(i){
		if ($(this).attr('checked') == true) {
			c_ids_arr[i] = $(this).val();
		}
	});
	c_ids = c_ids_arr.join(',');
		
	$.ajax({
		type: "POST",
		url: '/editor/ajax_coupon_list.php',
		data: "action=batchProcess&site=" + site + "&c_ids=" + c_ids + "&info=" + $("#" + pos).val(),
		success: function(msg){
			if (msg == 'success') {
				alert('Operation is successfully executed!');
				window.location.reload();
			} else {
				alert('Operation executed failed!');
			}
		}
	});
}

function markSelectedItems2(pos) {
	
	var _flag = false;
	var _validateflag = true;
	
	var posval = $("#" + pos).val();
	$(".processtatuscheckbox").each(function(i, obj){
		var attr_status = $(obj).attr('attr_status');
		var attr_type = $(obj).attr('attr_type');
		
		if ($(this).attr('checked') == true) {
			_flag = true;
//			alert(posval+"|"+ attr_status+"|"+attr_type);
			if(posval != "RemindDate"){
				if(posval != "Type-1" && posval !="Type-3" && posval != "Type-4"){
					if(posval == attr_status){
						 _validateflag = false;
					}
				}else{
					if(attr_type == posval){
						 _validateflag = false;
					}
				}
			}
			
			
			return;
		}
	});
	
	if (_flag != true) {
		alert('Please select at least 1 promotion first!');
		return false;
	}
	
	if (_validateflag != true) {
		alert('Same status. Please confirm your actions.');
		return false;
	}
    
	if ($("#" + pos).val() == 'All') {
		alert('Please select batch action Type first!');
		return false;
	} else if ($("#" + pos).val() == 'IsActive-YES') {
		if (!confirm("Please confirm to set selected promotions Active?")) return false;
	} else if ($("#" + pos).val() == 'IsActive-NO') {
		if (!confirm("Please confirm to set selected promotions Inactive?")) return false;
	} else if ($("#" + pos).val() == 'ExpireDateType-Fixed') {
		if (!confirm("Please confirm to set selected promotions Expired?")) return false;
	} else if ($("#" + pos).val() == 'RemindDate') {
		if (!confirm("Please confirm to delay reminddate selected promotions?")) return false;
	}
	
 	$.colorbox({
	    inline:true, 
	    opacity:0.5, 
	    overlayClose:false, 
	    speed:350, 
	    width: "50%", 
	    height:"58%",
	    close: "å…³é—­",
	    href:"#divPop3"
  });
}

function ajax_batch_process(pos){
	var c_ids;
	var c_ids_arr = new Array();
	var site = $("#site").val();
	 var info = $("#" + pos).val();
	var samecomments =$("#samecomments").val();
	var remark_sel =$("#remark_sel").val();
	if(remark_sel == -1){
		alert("Please select reasons!");
		$("#remark_sel").focus();
		return false;
	}
	var tmpstr = ";";
	if(remark_sel == ""){
		tmpstr = "";
	}
	samecomments = remark_sel + tmpstr + " " + samecomments;
	samecomments = encodeURIComponent(samecomments);
	
	$(".processtatuscheckbox").each(function(i){
		if ($(this).attr('checked') == true) {
			c_ids_arr[i] = $(this).val();
		}
	});
	c_ids = c_ids_arr.join(',');
	
	
	$.ajax({
		type: "POST",
		url: '/editor/ajax_coupon_list.php',
		data: "action=batchProcess&site=" + site + "&c_ids=" + c_ids + "&info=" + info+"&samecomments="+samecomments,
		success: function(msg){
			if (msg == 'success') {
				alert('Operation is successfully executed!');
				$("#samecomments").val("")
				window.location.reload();
			} else {
				alert('Operation executed failed!');
			}
		}
	});
}

function addClickOnEditArea() {
	$(".editable").each(function(){
		$(this).bind("click.Coupon", function(event){
			event.stopPropagation();
			var _self = this;
			var parentTop = $(_self).parent().offset().top;
			var parentLeft = $(_self).parent().offset().left;
			
			$("#poplayer").html('');
			$("#poplayer").css({display: 'block', left: parentLeft, top: parentTop});
			
			var site = $("#site").val();
			var couponid = $(_self).parent().parent().attr('couponid');
			var coupontype = $(_self).parent().parent().attr('coupontype');
			var field = $(_self).parent().attr('fieldinfo');
			var clickelementid = $($(this).html()).attr('id');
			
			layerVisible = true;
			var layer = generateLayerElements(field, couponid, coupontype, site, clickelementid);
			$(".bglayer").attr('style', 'display:block;');
			$("#poplayer").html(layer);
			
		});
	});
}

function generateLayerElements(field, couponid, coupontype, site, clickelementid) {
	var field = trim(field);
	var fieldDetailArr = fieldinfo_prefix[field];
	var elements = '';
	
	if (field == 'codepromotiondeal') {
		if (clickelementid == 'psitewide_' + couponid) {
			var sitewide = $("#site_wide_" + couponid).val();
			elements += generateCouponSiteWideSelect(trim(sitewide));
		} else {
			var code = $("#code_" + couponid).val();
			/*var promOff = $("#pro_off_" + couponid).val();
			var moneyType = $("#money_type_" + couponid).val();
			var promDetail = $("#pro_detail_" + couponid).val();
			var couponMoneyVisible = promOffVisible = false;
			
			if (coupontype == 1 || coupontype == 2 || coupontype == 5) {
				elements += '<input class="codepromotiondeal" id="code_" type="text" size="12" value="' + code + '"><br /><br />';
			}
			
			if (trim(promDetail) == 'percent') {
				promOffVisible = true;
			} else if (trim(promDetail) == 'money') {
				couponMoneyVisible = true;
				promOffVisible = true;
			}
			
			elements += generatePromotionDetailSelect(trim(promDetail)) + '&nbsp;&nbsp;' + generateCouponMoneySelect(trim(moneyType), couponMoneyVisible) + '&nbsp;&nbsp;';
			
			if (promOffVisible) elements += '<input class="codepromotiondeal" id="pro_off_" type="text" size="5" value="' + trim(promOff) + '">&nbsp;&nbsp;';
			else elements += '<input class="codepromotiondeal" id="pro_off_" type="text" size="5" value="' + trim(promOff) + '" style="display:none;">&nbsp;&nbsp;';*/
			var pmsg = '<form id="promotionform_'+couponid+'" target="promotiondealifrm" action="/editor/ajax_coupon_list.php">';
				pmsg += '<input type="hidden" name="action" value="couponEdit">';
				pmsg += '<input type="hidden" name="field" value="codepromotiondeal">';
				pmsg += '<input type="hidden" name="site" value="'+site+'">';
				pmsg += '<input type="hidden" name="couponid" value="'+couponid+'">';
				pmsg += '<input type="hidden" name="coupontype" value="'+coupontype+'">';
				if(code){
				pmsg += '<p><input type="text" value="'+code+'" size="12" name="code"></p>';
				}
			$.ajax({
				type: "POST",
				async: false,
				url: '/editor/ajax_coupon_list.php',
				data: "action=couponEdit&field=promotionform&site=" + site + "&couponid=" + couponid + "&coupontype=",
				success: function(msg){
					pmsg += msg;
					//alert(msg);
				}
			});
			elements += pmsg+'</form>';
		}
		
	} else if (field == 'title') {
		var title = $("#title_" + couponid).val();
		title = title.replace('"', '&#34;');
		elements += '<input class="title" id="title_" type="text" size="30" value="' + trim(title) + '">';
		
	} else if (field == 'description') {
		var description = $("#desc_" + couponid).val();
		elements += '<textarea class="description" id="desc_" rows=5 cols=60>' + trim(description) + '</textarea>';
		
	} else if (field == 'restrict') {
		var restrict = $("#restrict_" + couponid).val();
		elements += '<textarea class="restrict" id="restrict_" rows=5 cols=60>' + trim(restrict) + '</textarea>';
	} else if (field == 'startenddate') {
		for (var j in visible_field_info_prefix['startenddate']) {
			if (j + couponid == clickelementid) {
				for (var l in field_visible_mapping) {
					if (field_visible_mapping[l] == j) {
						var date = $("#" + l + couponid).val();
						elements += '<input class="startenddate" id="' + l + '" size="10" type="text" value="' + date + '" onFocus="WdatePicker({readOnly:true});">';
					}
				}
			}
		}
	} else if (field == 'tags') {
		var tags = $("#tagsall_" + couponid).val();
		tags = trim(tags);
		if (tags != '') {
			var tagsArr = tags.split(",");
			elements += '<div id="tagdiv">';
			for (var i in tagsArr) {
				elements += '<span tagval="' + tagsArr[i] + '" onclick="$(this).remove();">' + tagsArr[i] + ' (<font color="red">X</font>),</span> ';
			}
			elements += '</div>';
		}
		elements += '<textarea class="tags" id="tagsall_" rows=5 cols=30 style="display:none;"></textarea>';
		
	} else if (field == 'sources') {
		var sources = $("#sourcesall_" + couponid).val();
		sources = trim(sources);
		if (sources != '') {
			var sourcesArr = sources.split(",");
			elements += '<div id="sourcediv">';
			/*for (var i in sourcesArr) {
				var sourcedetail = sourcesArr[i].split(";");
				elements += '<span id="couponsource_' + sourcedetail[0] +'" sourceval="' + sourcedetail[1] + '" >' + sourcedetail[1] + ' ,</span> ';
			}*/
			elements += '</div>';
		}
		elements += '<textarea class="sources" id="sourcesall_" rows=5 cols=30 style="display:none;"></textarea>';
		elements += '<br />';
		elements += 'Edit: ' + generateCouponSourceSelect();
		elements += '<br /><br />ID In Souce: <input id="sourceid" type="text" size="10">';
	}else if(field == 'category'){
		var tags = $("#category_all_hide_" + couponid).val();
		tags = trim(tags);
		if (tags != '') {
			var tagsArr = tags.split(",");
			elements += '<div id="categorydiv">';
			for (var i in tagsArr) {
				elements += '<span categoryval="' + tagsArr[i] + '" onclick="$(this).remove();">' + tagsArr[i] + ' (<font color="red">X</font>),</span> ';
			}
			elements += '</div>';
		}
		elements += '<textarea class="category" class="tags" id="categorys_" rows=5 cols=30  style="display:none;"></textarea>';
	}
    
	if (field == 'sources') {
		var confirmButton = '<div style="padding:10px 0 0 0"><input class="btn_pos" type="button" value="Save" onclick="submitCouponSourceEdit(\'' + field + '\', \'' + couponid + '\', \'' + coupontype + '\', \'' + site + '\', \'' + clickelementid + '\')">&nbsp;&nbsp;<input class="btn_nag" type="button" value="Close" onclick="closeLayer();"></div>';
	}
	else 
		var confirmButton = '<div style="padding:10px 0 0 0"><input class="btn_pos" type="button" value="Save" onclick="submitCouponEdit(\'' + field + '\', \'' + couponid + '\', \'' + coupontype + '\', \'' + site + '\', \'' + clickelementid + '\')">&nbsp;&nbsp;<input class="btn_nag" type="button" value="Cancel" onclick="closeLayer();"></div>';
	
	elements += confirmButton;
	
	return elements;
}

function submitCouponSourceEdit(field, couponid, coupontype, site, clickelemid) {
	var newsource = $('#sourcenew_').val();
	var newsourceid = $("#sourceid").val();
	if(newsource == "none" || newsource == ""){
		alert("Coupon Source cannot be left blank, please select one.");
		return false
	}
	$.ajax({
		type: "POST",
		url: '/editor/ajax_coupon_list.php',
		data: "action=couponEdit&field=" + field + "&site=" + site + "&couponid=" + couponid + "&coupontype=" + coupontype + "&newsource=" + encodeURIComponent(newsource) + "&newsourceid=" + newsourceid,
		success: function(msg){
			if (msg == 'success') {
				closeLayer();
				window.location.reload();
			} else {
				alert('Operation executed failed!');
			}
		}
	});
}

function closeSourceLayer() {
	window.location.reload();
}

function submitCouponEdit(field, couponid, coupontype, site) {
	var couponEditQueryString = '';
	var fieldHiddenValueTmp = new Array();
	var fieldVisibleValueTmp = new Array();

	if (field == 'startenddate') {
//		var sdate = $("#sdate_", $("#poplayer")[0]).val();
//		var edate = $("#edate_", $("#poplayer")[0]).val();
//		
//		if (sdate == '' || sdate == '0000-00-00' || edate == '' || edate == '0000-00-00') {
//			alert('StartDate or EndDate is invalid!');
//			return false;
//		}
	} else if (field == 'tags') {
		var tagsStr = '';
		
		$("#tagdiv span").each(function(){
			tagsStr += trim($(this).attr('tagval')) + ",";
		});
		
		if (tagsStr != '') {
			tagsStr = tagsStr.substr(0, tagsStr.length - 1);
		}
		
		$("#tagsall_").val(tagsStr);
	} else if (field == 'category') {
		
		var tagsStr = '';
		$("#categorydiv span").each(function(){
			tagsStr += trim($(this).attr('categoryval')) + ",";
		});
		
		if (tagsStr != '') {
			tagsStr = tagsStr.substr(0, tagsStr.length - 1);
		}
		$("#categorys_").val(tagsStr);
	}
	$("." + field).each(function(){
		var currentId = $(this).attr('id');
		couponEditQueryString += "&" + currentId + "=" + encodeURIComponent($("#" + currentId, $("#poplayer")[0]).val());
		
		fieldHiddenValueTmp[currentId] = $("#" + currentId, $("#poplayer")[0]).val();
	});

	if (field == 'codepromotiondeal') {
		$("#poplayer #promotionform_"+couponid).attr('action',"/editor/ajax_coupon_list.php");
		$("#poplayer #promotionform_"+couponid).submit();
		return false;
		fieldVisibleValueTmp['psitewide_'] = fieldHiddenValueTmp['site_wide_'];
		fieldVisibleValueTmp['couponcode_'] = fieldHiddenValueTmp['code_'];
		
		if (fieldHiddenValueTmp['pro_detail_'] == 'percent') {
			fieldVisibleValueTmp['pdetail_'] = fieldHiddenValueTmp['pro_off_'] + promotion_detail['percent'];
		} else if (fieldHiddenValueTmp['pro_detail_'] == 'money') {
			fieldVisibleValueTmp['pdetail_'] = coupon_money[fieldHiddenValueTmp['money_type_']] + fieldHiddenValueTmp['pro_off_'] + ' OFF';
		} else {
			fieldVisibleValueTmp['pdetail_'] = fieldHiddenValueTmp['pro_detail_'];
		}
	} else { 
		for (var i in fieldHiddenValueTmp) {
			fieldVisibleValueTmp[field_visible_mapping[i]] = fieldHiddenValueTmp[i];
		}
	}
	$.ajax({
		type: "POST",
		url: '/editor/ajax_coupon_list.php',
		data: "action=couponEdit&field=" + field + "&site=" + site + "&couponid=" + couponid + "&coupontype=" + coupontype + couponEditQueryString,
		success: function(msg){
			$(".bglayer").attr('style', 'display:none;');
			if (msg == 'success') {
				//alert('Operation successfully executed!');
				closeLayer();
				
				for (var i in fieldVisibleValueTmp) {
					if (fieldVisibleValueTmp[i] != 'undefined') $("#" + i + couponid).html(fieldVisibleValueTmp[i]);
				}
				
				for (var i in fieldHiddenValueTmp) {
					if (fieldHiddenValueTmp[i] != 'undefined') $("#" + i + couponid).val(fieldHiddenValueTmp[i]);
				}
				if(field == "category"){
					window.location.reload();
				}
			} else {
				alert('Operation executed failed!');
			}
		}
	});
}

function promotionCallback(msg){
	if(msg.indexOf("success")>-1){
		var arr = msg.split('|');
		var id = arr[1];
		var list = arr[2];
		$("#pdetail_"+id).html(list);
		//$("#poplayer form").clone(true).prependTo("#promotiondetail_"+id);
		//$("#promotiondetail_"+id+" form").html($("#poplayer form").html());
		closeLayer();
		//window.location.reload();
	}else{
		alert(msg);
	}
}

function trim(text)
{
	if (typeof(text) == "string") return text.replace(/^\s*|\s*$/g, "");
    else return text;
}

function showSources(id){
	$("#sources_"+id).toggle("normal");
}
function promoticonDetailCheck(obj){
	var name = $(obj).val();
	if($(obj).attr('checked')){
		if(name=='other'){
			$("#poplayer input[type='checkbox']").attr('checked','');
			$(obj).attr('checked','checked');
		}else{
			$("#poplayer input[value='other']").attr('checked','');
		}
	}
}